<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ñzel TV - Proxy & HLS Fix</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        :root { --red: #e50914; --bg: #000; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #auth-screen input { padding: 15px; font-size: 20px; text-align: center; border-radius: 8px; border: 2px solid var(--red); background: #111; color: white; width: 220px; margin-bottom: 20px; }
        #main-wrapper { display: none; width: 100%; height: 100%; }
        #playlist-container { width: 280px; height: 100%; background: #0a0a0a; position: fixed; left: 0; top: 0; z-index: 100; border-right: 1px solid #222; overflow-y: auto; transition: 0.3s; }
        .playlist-item { padding: 15px; border-bottom: 1px solid #1a1a1a; cursor: pointer; }
        #player-area { position: absolute; left: 280px; right: 0; top: 0; bottom: 0; transition: 0.3s; }
        .full-view #player-area { left: 0; }
        .full-view #playlist-container { transform: translateX(-280px); }
        video { width: 100%; height: 100%; background: #000; object-fit: contain; }
        .controls { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.9)); padding: 30px 20px 15px; z-index: 200; }
        button { background: var(--red); border: none; color: white; padding: 10px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .sec-btn { background: #333; margin-left: 5px; }
        #debug-msg { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: lime; padding: 10px; font-size: 11px; z-index: 1000; pointer-events: none; border-radius: 5px; }
    </style>
</head>
<body>

<div id="debug-msg">Sistem Hazƒ±r.</div>

<div id="auth-screen">
    <h2 style="color:var(--red)">üîë ERƒ∞≈ûƒ∞M</h2>
    <input type="password" id="passInp" placeholder="≈ûifre">
    <button onclick="login()">Gƒ∞Rƒ∞≈û</button>
</div>

<div id="main-wrapper">
    <div id="playlist-container">
        <h3 style="padding:15px; color:var(--red);">üì∫ Lƒ∞STEM</h3>
        <div id="list-items"></div>
    </div>
    <div id="player-area">
        <div id="yt-wrap" style="display:none; width:100%; height:100%;"><div id="yt-player"></div></div>
        <video id="v-player" playsinline crossorigin="anonymous"></video>
        <div class="controls">
            <input type="range" style="width:100%; accent-color:red" id="seek" value="0" step="0.1">
            <div style="display:flex; justify-content:space-between; margin-top:10px">
                <div>
                    <button onclick="togglePlay()" id="playBtn">‚è∏</button>
                    <input type="number" id="jumpMin" style="width:50px; padding:8px" placeholder="DK">
                    <button onclick="doJump()" class="sec-btn">Gƒ∞T</button>
                    <button id="ccBtn" class="sec-btn" onclick="toggleCC()" style="display:none;">CC</button>
                </div>
                <button class="sec-btn" onclick="toggleFS()">‚õ∂ TAM EKRAN</button>
            </div>
        </div>
    </div>
</div>

<script>
    const fbConfig = {
        apiKey: "AIzaSyDVS-jg8FkE9xuUfzlnYboKrqsHHTL3Bvo",
        databaseURL: "https://naberdeneme-ffa04-default-rtdb.firebaseio.com",
        projectId: "naberdeneme-ffa04"
    };

    let ytPlayer, hls, isYT = false;
    const video = document.getElementById('v-player');
    const debug = document.getElementById('debug-msg');

    function log(msg) { debug.innerText = msg; }

    function login() {
        if(document.getElementById('passInp').value === "755654") {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-wrapper').style.display = 'block';
            if(!firebase.apps.length) firebase.initializeApp(fbConfig);
            loadList();
        } else { alert("≈ûifre Hatalƒ±!"); }
    }

    function loadList() {
        firebase.database().ref('ozel_videolar').on('value', s => {
            const container = document.getElementById('list-items');
            container.innerHTML = "";
            s.forEach(child => {
                const item = child.val();
                const div = document.createElement('div');
                div.className = 'playlist-item';
                div.innerHTML = `<b>${item.title}</b>`;
                div.onclick = () => playNow(item);
                container.appendChild(div);
            });
        });
    }

    async function playNow(data) {
        log("Ba≈ülatƒ±lƒ±yor...");
        if(hls) { hls.destroy(); hls = null; }
        video.pause();
        video.src = "";
        
        // Altyazƒ± temizliƒüi
        while(video.firstChild) video.removeChild(video.firstChild);

        isYT = data.v_url.includes('youtube.com') || data.v_url.includes('youtu.be');

        if(isYT) {
            document.getElementById('yt-wrap').style.display = 'block';
            video.style.display = 'none';
            const id = data.v_url.split('v=')[1]?.split('&')[0] || data.v_url.split('embed/')[1];
            if(!ytPlayer) {
                ytPlayer = new YT.Player('yt-player', { height:'100%', width:'100%', videoId:id, playerVars:{'autoplay':1} });
            } else { ytPlayer.loadVideoById(id); }
        } else {
            document.getElementById('yt-wrap').style.display = 'none';
            video.style.display = 'block';

            let finalUrl = data.v_url;

            if (finalUrl.includes('.m3u8')) {
                // PROXY KULLANIMI: Linki CORS engelini a≈üacak bir k√∂pr√ºye y√∂nlendiriyoruz
                // √ñnemli: AllOrigins veya benzeri servisler m3u8 i√ßindeki par√ßalarƒ± bazen √ßekemez.
                // Eƒüer hata devam ederse linkin ba≈üƒ±na 'https://corsproxy.io/?' eklemeyi deneriz.
                log("M3U8 HLS Y√ºkleniyor...");
                
                if (Hls.isSupported()) {
                    hls = new Hls();
                    hls.loadSource(finalUrl);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => { log("Oynatƒ±lƒ±yor."); video.play(); });
                    
                    hls.on(Hls.Events.ERROR, (event, errData) => {
                        if (errData.fatal) {
                            log("Hata: " + errData.details + ". Proxy Deneniyor...");
                            // Fatal hata durumunda proxy ile tekrar dene
                            if(!finalUrl.includes('corsproxy')) {
                                finalUrl = "https://corsproxy.io/?" + encodeURIComponent(data.v_url);
                                hls.loadSource(finalUrl);
                            }
                        }
                    });
                }
            } else {
                video.src = finalUrl;
                video.play();
            }

            // Altyazƒ± Y√ºkleme (VTT)
            if(data.vtt_url) {
                document.getElementById('ccBtn').style.display = 'inline-block';
                const track = document.createElement('track');
                track.kind = 'captions'; track.label = 'T√ºrk√ße'; track.srclang = 'tr'; track.default = true;
                // Altyazƒ± i√ßin proxy
                track.src = "https://api.allorigins.win/raw?url=" + encodeURIComponent(data.vtt_url);
                video.appendChild(track);
            }
        }
        syncLoop();
    }

    function togglePlay() {
        if(isYT) { (ytPlayer.getPlayerState() === 1) ? ytPlayer.pauseVideo() : ytPlayer.playVideo(); }
        else { video.paused ? video.play() : video.pause(); }
    }

    function doJump() {
        const val = document.getElementById('jumpMin').value * 60;
        if(isYT) ytPlayer.seekTo(val); else video.currentTime = val;
    }

    function syncLoop() {
        const cur = isYT ? ytPlayer?.getCurrentTime() : video.currentTime;
        const dur = isYT ? ytPlayer?.getDuration() : video.duration;
        if(dur) { 
            document.getElementById('seek').max = dur; 
            document.getElementById('seek').value = cur; 
        }
        requestAnimationFrame(syncLoop);
    }

    function toggleFS() {
        if(!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            document.body.classList.add('full-view');
        } else {
            document.exitFullscreen();
            document.body.classList.remove('full-view');
        }
    }
    
    function toggleCC() {
        const t = video.textTracks[0];
        if(t) t.mode = t.mode === 'showing' ? 'hidden' : 'showing';
    }
</script>
</body>
</html>
